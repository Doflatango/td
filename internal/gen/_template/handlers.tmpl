{{ define "handlers" }}
{{ $pkg := $.Package }}
{{ template "header" $ }}

type handler = func(context.Context, Entities, UpdateClass) error

type UpdateDispatcher struct {
    handlers map[uint32]handler
}

func NewUpdateDispatcher() UpdateDispatcher {
    return UpdateDispatcher{
        handlers: map[uint32]handler{},
    }
}

type Entities struct {
    Short bool
    Users map[int]*User
    Chats map[int]*Chat
    Channels map[int]*Channel
    init bool
}

func (u *Entities) lazyInitFromUpdates(updates *Updates) {
    if u.init {
        return
    }

    u.init = true
    u.Users = updates.MapUsers().NotEmptyToMap()
    chats := updates.MapChats()
    u.Chats = chats.ChatToMap()
    u.Channels = chats.ChannelToMap()
}

func (u *Entities) short() {
    if u.init {
        return
    }
    u.init = true

    u.Short = true
    u.Users = make(map[int]*User, 0)
    u.Chats = make(map[int]*Chat, 0)
    u.Channels = make(map[int]*Channel, 0)
}

// Handle implements UpdateDispatcher.
func (u UpdateDispatcher) Handle(ctx context.Context, updates *Updates) error {
    e := Entities{}

    var err error
	for _, update := range updates.Updates {
        e.lazyInitFromUpdates(updates)
        multierr.AppendInto(&err, u.dispatch(ctx, e, update))
	}
	return nil
}

// HandleShort implements UpdateDispatcher.
func (u UpdateDispatcher) HandleShort(ctx context.Context, short *UpdateShort) error {
    e := Entities{}
    e.short()
    return u.dispatch(ctx, e, short.Update)
}

func (u UpdateDispatcher) dispatch(ctx context.Context, e Entities, update UpdateClass) error {
    if update == nil {
        return nil
    }
    typeID := update.TypeID()
    handler, ok := u.handlers[typeID]
    if !ok {
        return nil
    }
    return handler(ctx, e, update)
}

{{- range $s := $.Structs }}{{ if eq $s.Interface "UpdateClass" }}
{{ $eventName := trimPrefix $s.Name "Update"}}
// {{ $eventName }}Handler is a {{ $eventName }} event handler.
type {{ $eventName }}Handler func(ctx context.Context, e Entities, update *{{ $s.Name }}) error

// On{{ $eventName }} sets {{ $eventName }} handler.
func (u UpdateDispatcher) On{{ $eventName }}(handler {{ $eventName }}Handler) {
    u.handlers[{{ $s.Name }}TypeID] = func(ctx context.Context, e Entities, update UpdateClass) error {
        return handler(ctx, e, update.(*{{ $s.Name }}))
    }
}
{{- end }}{{ end }}

{{ end }}
